SELECT  ROUTES.IDROUTES ,ROUTES.NORN ,ROUTES.IDVILLEDEPART ,ROUTES.IDVILLEARRIVE ,ROUTES.DISTANCE ,D.NOMVILLES DEPART ,F.NOMVILLES ARRIVE,COALESCE(DIST,100) GLOB FROM ROUTES JOIN VILLES D ON ROUTES.IDVILLEDEPART=D.IDVILLES JOIN VILLES F ON ROUTES.IDVILLEARRIVE=F.IDVILLES LEFT JOIN V_GLOBAL ON ROUTES.IDROUTES=V_GLOBAL.IDROUTES;

CREATE VIEW V_GLOBAL AS
SELECT V1.IDROUTES, ROUND(100*V1.DISTANCE/V2.DISTANCE,2) DIST FROM (SELECT IDROUTES,SUM(DISTANCE) DISTANCE FROM PORTIONSROUTES WHERE IDETATS=1 GROUP BY IDROUTES) V1 JOIN (SELECT IDROUTES,SUM(DISTANCE) DISTANCE FROM PORTIONSROUTES GROUP BY IDROUTES) V2 ON
V1.IDROUTES=V2.IDROUTES;